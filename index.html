<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wing Stars 戰績排行榜（V4.1 美化版）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="p-4">

  <div id="loading">資料載入中...</div>

  <h1 id="pageTitle">Wing Stars 戰績排行榜（V4.1 美化版）</h1>

  <div class="card">
    <ul class="nav nav-tabs flex-wrap" id="tabs">
      <li class="nav-item mb-2"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#home" data-type="home">主場戰績</button></li>
      <li class="nav-item mb-2"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#away" data-type="away">客場戰績</button></li>
      <li class="nav-item mb-2"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#combined" data-type="combined">總戰績</button></li>
      <li class="nav-item mb-2"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#attendance" data-type="attendance">出勤場次排行榜</button></li>
      <li class="nav-item mb-2"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#chartA" data-type="chartA">勝率排行榜</button></li>
      <li class="nav-item mb-2"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#chartC" data-type="chartC">主客場勝率比較</button></li>
      <li class="nav-item mb-2"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#chartD" data-type="chartD">連勝連敗排行榜</button></li>
      <li class="nav-item mb-2"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#heatmap" data-type="heatmap">出勤熱力圖</button></li>
    </ul>
  </div>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="home"></div>
    <div class="tab-pane fade" id="away"></div>
    <div class="tab-pane fade" id="combined"></div>
    <div class="tab-pane fade" id="attendance"></div>
    <div class="tab-pane fade" id="chartA"><canvas id="canvasA" height="400"></canvas></div>
    <div class="tab-pane fade" id="chartC"><canvas id="canvasC" height="400"></canvas></div>
    <div class="tab-pane fade" id="chartD"><canvas id="canvasD" height="400"></canvas></div>
    <div class="tab-pane fade" id="heatmap"><canvas id="canvasHeatmap" height="600"></canvas></div>
  </div>

  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalName">出勤明細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><ul id="modalList" class="list-group"></ul></div>
    </div></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@4.1.0/dist/chartjs-chart-matrix.min.js"></script>
<script>
let fullData = {};
let sortState = {"combined": null, "home": null, "away": null};
let chartRendered = {"chartA": false, "chartC": false, "chartD": false, "attendance": false, "heatmap": false};

async function loadData() {
  const res = await fetch('cheerleader_stats_data.json');
  fullData = await res.json();
  document.getElementById("loading").style.display = "none";
  ['home','away','combined'].forEach(type => renderTable(type));
}
function renderChartD() {
  const data = [...fullData['combined']].map(d => ({
    name: d.name,
    streak: d.current.includes('連勝') ? parseInt(d.current) :
            d.current.includes('連敗') ? -parseInt(d.current) : 0
  })).sort((a,b)=>b.streak - a.streak);
  const names = data.map(d => d.name);
  const streaks = data.map(d => d.streak);
  new Chart(document.getElementById('canvasD'), {
    type: 'bar',
    data: { labels: names, datasets: [{
      label: '目前連勝/連敗',
      data: streaks,
      backgroundColor: streaks.map(v => v>=0 ? '#34D399' : '#F87171')
    }] },
    options: { responsive: true, indexAxis: 'x', animation: {duration: 800}, scales: { y: { beginAtZero: true } } }
  });
}

function renderHeatmap() {
  const combined = fullData['combined'];
  const members = combined.map(d => d.name);
  const dateSet = new Set();
  combined.forEach(m => {
    if (m.detail) {
      m.detail.forEach(d => {
        if (d.date) dateSet.add(d.date);
      });
    }
  });
  const dates = Array.from(dateSet).sort();

  if (dates.length === 0 || members.length === 0) {
    console.warn("沒有任何出勤日期資料，跳過熱力圖");
    return;
  }

  const data = [];
  combined.forEach((m, row) => {
    const datesSet = new Set((m.detail || []).map(d => d.date));
    dates.forEach((date, col) => {
      data.push({ x: col, y: row, v: datesSet.has(date) ? 1 : 0 });
    });
  });

  const ctx = document.getElementById('canvasHeatmap').getContext('2d');
  new Chart(ctx, {
    type: 'matrix',
    data: {
      datasets: [{
        label: '出勤',
        data: data,
        backgroundColor: d => d.raw.v ? '#34D399' : '#E5E7EB',
        width: ({chart}) => (chart.chartArea || {}).width / dates.length - 1,
        height: ({chart}) => (chart.chartArea || {}).height / members.length - 1
      }]
    },
    options: {
      responsive: true,
      animation: {duration: 800},
      scales: {
        x: { type: 'linear', position: 'top', ticks: {
          callback: val => dates[val] || ''
        }, grid: {display: false}},
        y: { type: 'linear', ticks: {
          callback: val => members[val] || ''
        }, grid: {display: false}}
      }
    }
  });
}

function showDetail(name, type) {
  const item = fullData[type].find(d => d.name === name);
  document.getElementById('modalName').innerText = `${item.name} 出勤明細`;
  const ul = document.getElementById('modalList'); ul.innerHTML = '';
  item.detail.forEach(d => {
    const li = document.createElement('li');
    li.innerHTML = `
      <span>${d.date}（${d.weekday_fixed}）</span>
      <span>${d.stadium}</span>
      <span>${d.result} ${d.opponent_fixed} ${d.opp_score}：${d.self_score} 啾啾</span>`;
    ul.appendChild(li);
  });
  new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function updateTitleDate() {
  const title = document.getElementById("pageTitle");
  const today = new Date();
  today.setDate(today.getDate() - 1);
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const dateStr = `${yyyy}-${mm}-${dd}`;
  title.innerText = `Wing Stars 戰績排行榜（截至 ${dateStr}）`;
}

document.querySelectorAll('#tabs button').forEach(btn => {
  btn.addEventListener('shown.bs.tab', e => {
    const type = e.target.dataset.type;
    if (type === 'chartA' && !chartRendered.chartA) { renderChartA(); chartRendered.chartA = true; return; }
    if (type === 'chartC' && !chartRendered.chartC) { renderChartC(); chartRendered.chartC = true; return; }
    if (type === 'chartD' && !chartRendered.chartD) { renderChartD(); chartRendered.chartD = true; return; }
    if (type === 'attendance' && !chartRendered.attendance) { renderAttendanceTable(); chartRendered.attendance = true; return; }
    if (type === 'heatmap' && !chartRendered.heatmap) { renderHeatmap(); chartRendered.heatmap = true; return; }
    if (type !== 'chartA' && type !== 'chartC' && type !== 'chartD' && type !== 'attendance' && type !== 'heatmap') {
      sortState[type] = null;
      renderTable(type);
    }
  });
});

loadData().then(updateTitleDate);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body></html>
