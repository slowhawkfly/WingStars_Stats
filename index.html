<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wing Stars 戰績排行榜（V1.8）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #F9FAFB; color: #111827; }
    th { cursor: pointer; }
    .avatar-placeholder { width: 40px; height: 40px; border-radius: 50%; background-color: #FCA5A5; display: inline-block; }
    .nav-tabs .nav-link.active { background-color: #34D399; color: white; }
    .table-striped>tbody>tr:nth-of-type(odd) { background-color: #F3F4F6; }
    .btn-outline-primary { border-color: #FCA5A5; color: #FCA5A5; }
    .btn-outline-primary:hover { background-color: #FB7185; color: white; }
  </style>
</head>
<body class="p-4">

  <h1 class="mb-4" id="pageTitle">Wing Stars 戰績排行榜（V1.8）</h1>

  <ul class="nav nav-tabs" id="tabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#home" data-type="home">主場戰績</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#away" data-type="away">客場戰績</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#combined" data-type="combined">總戰績</button></li>
  </ul>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="home"></div>
    <div class="tab-pane fade" id="away"></div>
    <div class="tab-pane fade" id="combined"></div>
  </div>

  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalName">出勤明細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><ul id="modalList" class="list-group"></ul></div>
    </div></div>
  </div>

<script>
let fullData = {};
let sortState = {"combined": null, "home": null, "away": null};

async function loadData() {
  const res = await fetch('cheerleader_stats_data.json');
  fullData = await res.json();
  ['home','away','combined'].forEach(type => renderTable(type));
}

function renderTable(type) {
  const container = document.getElementById(type);
  container.innerHTML = "";
  let data = fullData[type];

  if (!data || data.length === 0) {
    container.innerHTML = "<div class='alert alert-secondary'>目前尚無資料</div>";
    return;
  }

  data = [...data]; // clone array

  const table = document.createElement('table');
  table.className = "table table-striped table-hover align-middle";
  table.innerHTML = `
    <thead><tr>
      <th>照片</th>
      <th data-field="name">成員</th>
      <th data-field="total">出賽數</th>
      <th data-field="win">勝場數</th>
      <th data-field="lose">敗場數</th>
      <th data-field="winRate">勝率</th>
      <th data-field="current">目前連勝/敗</th>
      <th>出勤明細</th>
    </tr></thead><tbody></tbody>`;

  if (sortState[type]) {
    const {field, asc} = sortState[type];
    data.sort((a,b) => {
      let valA = a[field], valB = b[field];
      if (field === 'current') {
        const extract = s => s.includes('連勝') ? parseInt(s) : s.includes('連敗') ? -parseInt(s) : 0;
        valA = extract(valA); valB = extract(valB);
      }
      if (valA === valB) return 0;
      return (valA > valB ? 1 : -1) * (asc ? 1 : -1);
    });
  }

  const tbody = table.querySelector('tbody');
  data.forEach(item=>{
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><div class="avatar-placeholder"></div></td>
      <td>${item.name}</td>
      <td>${item.total}</td>
      <td>${item.win}</td>
      <td>${item.lose}</td>
      <td>${(item.winRate*100).toFixed(1)}%</td>
      <td>${item.current}</td>
      <td><button class='btn btn-sm btn-outline-primary' onclick='showDetail("${item.name}","${type}")'>查看</button></td>`;
    tbody.appendChild(row);
  });

  container.appendChild(table);

  table.querySelectorAll('th[data-field]').forEach(th=>{
    th.onclick = ()=>{
      const field = th.dataset.field;
      if (sortState[type] && sortState[type].field === field)
        sortState[type].asc = !sortState[type].asc;
      else
        sortState[type] = { field: field, asc: false };
      renderTable(type);
    }
  });
}

function showDetail(name, type) {
  const item = fullData[type].find(d => d.name === name);
  document.getElementById('modalName').innerText = `${item.name} 出勤明細`;
  const ul = document.getElementById('modalList');
  ul.innerHTML = '';
  item.detail.forEach(d => {
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.innerHTML = `
      日期：${d.date}（${d.weekday_fixed}）<br>
      地點：${d.stadium}<br>
      結果：${d.result}　${d.opponent_fixed} ${d.opp_score} ： ${d.self_score} 啾啾
    `;
    ul.appendChild(li);
  });
  new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function updateTitleDate() {
  const title = document.getElementById("pageTitle");
  const today = new Date();
  today.setDate(today.getDate() - 1); // 昨天
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const dateStr = `${yyyy}-${mm}-${dd}`;
  title.innerText = `Wing Stars 戰績排行榜（V1.8｜統計至 ${dateStr}）`;
}

document.querySelectorAll('#tabs button').forEach(btn => {
  btn.addEventListener('shown.bs.tab', e => {
    const type = e.target.dataset.type;
    sortState[type] = null;
    renderTable(type);
  });
});

loadData().then(updateTitleDate);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
