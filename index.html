<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wing Stars 戰績排行榜（V3.1 美化版）</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="p-4">

  <h1>Wing Stars 戰績排行榜（V3.1 美化版）</h1>

  <div class="card">
    <ul class="nav nav-tabs" id="tabs">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#home" data-type="home">主場戰績</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#away" data-type="away">客場戰績</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#combined" data-type="combined">總戰績</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#attendance" data-type="attendance">出勤場次排行榜</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#chartA" data-type="chartA">勝率排行榜</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#chartC" data-type="chartC">主客場勝率比較</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#chartD" data-type="chartD">連勝連敗排行榜</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#contribution" data-type="contribution">勝率貢獻分析</button></li>
    </ul>
  </div>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="home"></div>
    <div class="tab-pane fade" id="away"></div>
    <div class="tab-pane fade" id="combined"></div>
    <div class="tab-pane fade" id="attendance"></div>
    <div class="tab-pane fade" id="chartA"><canvas id="canvasA" height="400"></canvas></div>
    <div class="tab-pane fade" id="chartC"><canvas id="canvasC" height="400"></canvas></div>
    <div class="tab-pane fade" id="chartD"><canvas id="canvasD" height="400"></canvas></div>
    <div class="tab-pane fade" id="contribution"><canvas id="canvasContri" height="400"></canvas></div>
  </div>

  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalName">出勤明細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body"><ul id="modalList" class="list-group"></ul></div>
    </div></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let fullData = {};
let sortState = {"combined": null, "home": null, "away": null};
let chartRendered = {"chartA": false, "chartC": false, "chartD": false, "attendance": false, "contribution": false};

async function loadData() {
  const res = await fetch('cheerleader_stats_data.json');
  fullData = await res.json();
  ['home','away','combined'].forEach(type => renderTable(type));
}
function renderTable(type) {
  const container = document.getElementById(type);
  container.innerHTML = "";
  let data = fullData[type];
  if (!data || data.length === 0) {
    container.innerHTML = "<div class='alert alert-secondary'>目前尚無資料</div>";
    return;
  }
  data = [...data];

  const table = document.createElement('table');
  table.className = "table table-striped table-hover align-middle";
  table.innerHTML = `<thead><tr>
      <th>照片</th><th data-field="name">成員</th><th data-field="total">出賽數</th>
      <th data-field="win">勝場數</th><th data-field="lose">敗場數</th>
      <th data-field="winRate">勝率</th><th data-field="current">目前連勝/敗</th>
      <th>出勤明細</th></tr></thead><tbody></tbody>`;

  if (sortState[type]) {
    const {field, asc} = sortState[type];
    data.sort((a,b) => {
      let valA = a[field], valB = b[field];
      if (field === 'current') {
        const extract = s => s.includes('連勝') ? parseInt(s) : s.includes('連敗') ? -parseInt(s) : 0;
        valA = extract(valA); valB = extract(valB);
      }
      return (valA > valB ? 1 : -1) * (asc ? 1 : -1);
    });
  }
  const tbody = table.querySelector('tbody');
  data.forEach(item=>{
    const row = document.createElement('tr');
    row.innerHTML = `<td><div class="avatar-placeholder"></div></td>
      <td>${item.name}</td><td>${item.total}</td><td>${item.win}</td><td>${item.lose}</td>
      <td>${(item.winRate*100).toFixed(1)}%</td><td>${item.current}</td>
      <td><button class='btn btn-sm btn-outline-primary' onclick='showDetail("${item.name}","${type}")'>查看</button></td>`;
    tbody.appendChild(row);
  });
  container.appendChild(table);
  table.querySelectorAll('th[data-field]').forEach(th=>{
    th.onclick = ()=>{ const field = th.dataset.field;
      if (sortState[type] && sortState[type].field === field)
        sortState[type].asc = !sortState[type].asc;
      else sortState[type] = { field: field, asc: false };
      renderTable(type);
    }
  });
}

function renderAttendanceTable() {
  const container = document.getElementById('attendance');
  const data = [...fullData['combined']].sort((a,b)=>b.total - a.total);
  const table = document.createElement('table');
  table.className = "table table-striped table-hover align-middle";
  table.innerHTML = `<thead><tr><th>成員</th><th>出賽數</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector('tbody');
  data.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${item.name}</td><td>${item.total}</td>`;
    tbody.appendChild(row);
  });
  container.appendChild(table);
}

function renderChartA() {
  const data = [...fullData['combined']].sort((a,b)=>b.winRate - a.winRate);
  const names = data.map(d => d.name);
  const rates = data.map(d => (d.winRate*100).toFixed(1));
  new Chart(document.getElementById('canvasA'), {
    type: 'bar',
    data: { labels: names, datasets: [{ label: '勝率 (%)', data: rates, backgroundColor: '#34D399' }] },
    options: { responsive: true, indexAxis: 'x', scales: { y: { beginAtZero: true, max: 100 } } }
  });
}

function renderChartC() {
  const homeData = fullData['home'] || [];
  const awayData = fullData['away'] || [];
  const names = [...new Set([...homeData, ...awayData].map(d => d.name))];
  const homeMap = Object.fromEntries(homeData.map(d => [d.name, d.winRate*100]));
  const awayMap = Object.fromEntries(awayData.map(d => [d.name, d.winRate*100]));
  const homeRates = names.map(n => homeMap[n] || 0);
  const awayRates = names.map(n => awayMap[n] || 0);
  new Chart(document.getElementById('canvasC'), {
    type: 'bar',
    data: { labels: names, datasets: [
      { label: '主場勝率', data: homeRates, backgroundColor: '#60A5FA' },
      { label: '客場勝率', data: awayRates, backgroundColor: '#FBBF24' }
    ] },
    options: { responsive: true, indexAxis: 'x', scales: { y: { beginAtZero: true, max: 100 } } }
  });
}

function renderChartD() {
  const data = [...fullData['combined']].map(d => ({
    name: d.name,
    streak: d.current.includes('連勝') ? parseInt(d.current) :
            d.current.includes('連敗') ? -parseInt(d.current) : 0
  })).sort((a,b)=>b.streak - a.streak);
  const names = data.map(d => d.name);
  const streaks = data.map(d => d.streak);
  new Chart(document.getElementById('canvasD'), {
    type: 'bar',
    data: { labels: names, datasets: [{
      label: '目前連勝/連敗',
      data: streaks,
      backgroundColor: streaks.map(v => v>=0 ? '#34D399' : '#F87171')
    }] },
    options: { responsive: true, indexAxis: 'x', scales: { y: { beginAtZero: true } } }
  });
}

function renderContribution() {
  const data = [...fullData['combined']];
  const teamTotalWin = data.reduce((sum, d) => sum + d.win, 0);
  const teamTotalGames = data.reduce((sum, d) => sum + d.total, 0);
  const teamWinRate = teamTotalWin / teamTotalGames;
  const contribData = data.map(d => ({
    name: d.name,
    contrib: (d.winRate - teamWinRate) * 100
  })).sort((a,b)=>b.contrib - a.contrib);
  const names = contribData.map(d => d.name);
  const contribs = contribData.map(d => d.contrib.toFixed(1));
  new Chart(document.getElementById('canvasContri'), {
    type: 'bar',
    data: { labels: names, datasets: [{
      label: '勝率貢獻值 (%)',
      data: contribs,
      backgroundColor: contribs.map(v => v >= 0 ? '#34D399' : '#F87171')
    }] },
    options: { responsive: true, indexAxis: 'x', scales: { y: { beginAtZero: true } } }
  });
}

function showDetail(name, type) {
  const item = fullData[type].find(d => d.name === name);
  document.getElementById('modalName').innerText = `${item.name} 出勤明細`;
  const ul = document.getElementById('modalList'); ul.innerHTML = '';
  item.detail.forEach(d => {
    const li = document.createElement('li'); li.className = 'list-group-item';
    li.innerHTML = `日期：${d.date}（${d.weekday_fixed}）<br>地點：${d.stadium}<br>
      結果：${d.result}　${d.opponent_fixed} ${d.opp_score} ： ${d.self_score} 啾啾`;
    ul.appendChild(li);
  });
  new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function updateTitleDate() {
  const title = document.getElementById("pageTitle");
  const today = new Date();
  today.setDate(today.getDate() - 1);
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const dateStr = `${yyyy}-${mm}-${dd}`;
  title.innerText = `Wing Stars 戰績排行榜（截至 ${dateStr}）`;
}

document.querySelectorAll('#tabs button').forEach(btn => {
  btn.addEventListener('shown.bs.tab', e => {
    const type = e.target.dataset.type;
    if (type === 'chartA' && !chartRendered.chartA) { renderChartA(); chartRendered.chartA = true; return; }
    if (type === 'chartC' && !chartRendered.chartC) { renderChartC(); chartRendered.chartC = true; return; }
    if (type === 'chartD' && !chartRendered.chartD) { renderChartD(); chartRendered.chartD = true; return; }
    if (type === 'attendance' && !chartRendered.attendance) { renderAttendanceTable(); chartRendered.attendance = true; return; }
    if (type === 'contribution' && !chartRendered.contribution) { renderContribution(); chartRendered.contribution = true; return; }
    if (type !== 'chartA' && type !== 'chartC' && type !== 'chartD' && type !== 'attendance' && type !== 'contribution') {
      sortState[type] = null;
      renderTable(type);
    }
  });
});

loadData().then(updateTitleDate);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body></html>
